<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TKD Scout App</title>
    
    <!-- Tailwind CSS para estiliza√ß√£o r√°pida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Biblioteca jsPDF para gerar o PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Plugin para tabelas no jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Biblioteca Chart.js para criar os gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Biblioteca SortableJS para arrastar e soltar os itens da lista -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        /* Estilos personalizados para complementar o Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Remove o destaque azul ao tocar em links/bot√µes no mobile */
        }
        
        /* Estiliza√ß√£o da barra de rolagem para um visual mais limpo */
        .action-list::-webkit-scrollbar {
            width: 4px;
        }
        .action-list::-webkit-scrollbar-track {
            background: transparent;
        }
        .action-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 2px;
        }
        .action-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Anima√ß√£o para o modal deslizar de baixo para cima */
        #action-modal {
            transition: transform 0.3s ease-in-out;
            transform: translateY(100%);
        }
        #action-modal.active {
            transform: translateY(0);
        }

        /* Efeito de "pressionado" nos bot√µes de a√ß√£o */
        .action-button:active {
            transform: scale(0.95);
            filter: brightness(0.9);
        }
        
        /* Estilo para os itens arrast√°veis */
        .sortable-ghost {
            opacity: 0.4;
            background: #c8ebfb;
        }

        /* Estilo para o bot√£o de altern√¢ncia de atleta */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 80px;
            height: 40px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ef5350; /* Cor do Atleta 1 (Vermelho) */
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 32px;
            width: 32px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #42a5f5; /* Cor do Atleta 2 (Azul) */
        }
        input:checked + .slider:before {
            transform: translateX(40px);
        }
        
        /* Garante que os canvas dos gr√°ficos nunca sejam exibidos na tela */
        .chart-canvas {
            display: none !important;
        }
        
        #help-modal-header {
            cursor: move;
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center items-center min-h-screen">

    <!-- Container principal do aplicativo -->
    <div class="w-full max-w-md mx-auto bg-white shadow-lg rounded-lg flex flex-col h-screen">

        <!-- √Årea dos Atletas -->
        <main class="flex-grow p-4 flex flex-col gap-4 overflow-hidden">
            <div class="grid grid-cols-2 gap-4 flex-grow overflow-hidden">
                <!-- Coluna Atleta 1 (Vermelho) -->
                <div id="atleta1-container" class="flex flex-col border-2 border-red-400 rounded-lg transition-all duration-300 overflow-hidden">
                    <div class="p-2 text-center bg-red-100 rounded-t-lg">
                        <input type="text" id="atleta1-name" value="Atleta 1" class="w-full text-center bg-transparent font-bold text-red-800">
                    </div>
                    <div id="atleta1-list" class="action-list flex-grow p-2 space-y-2 overflow-y-auto bg-red-50"></div>
                    <div id="atleta1-score" class="p-2 text-center bg-red-400 text-white font-bold rounded-b-lg text-2xl">00</div>
                </div>
                <!-- Coluna Atleta 2 (Azul) -->
                <div id="atleta2-container" class="flex flex-col border-2 border-gray-300 rounded-lg transition-all duration-300 overflow-hidden">
                    <div class="p-2 text-center bg-gray-100 rounded-t-lg">
                        <input type="text" id="atleta2-name" value="Atleta 2" class="w-full text-center bg-transparent font-bold text-gray-800">
                    </div>
                    <div id="atleta2-list" class="action-list flex-grow p-2 space-y-2 overflow-y-auto bg-gray-50"></div>
                    <div id="atleta2-score" class="p-2 text-center bg-blue-400 text-white font-bold rounded-b-lg text-2xl">00</div>
                </div>
            </div>
        </main>

        <!-- Cron√¥metro e Controles -->
        <section class="p-4">
            <div class="bg-gray-100 p-3 rounded-lg shadow-inner">
                <div class="flex justify-between items-center px-4 mb-2">
                    <h2 class="text-xl font-bold text-gray-700">Round <span id="round-display">1</span></h2>
                    <div id="timer" class="text-4xl font-mono font-bold text-gray-800">00:00</div>
                </div>
                <div class="flex justify-around items-center mt-2 text-gray-600">
                    <button id="help-btn" class="p-2 rounded-full hover:bg-blue-100 hover:text-blue-500" title="Ajuda">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    </button>
                    <button id="reset-btn" class="p-2 rounded-full hover:bg-red-100 hover:text-red-500" title="Reiniciar Luta">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                    <button id="fullscreen-btn" class="p-2 rounded-full hover:bg-gray-200" title="Tela Cheia">
                        <svg id="fullscreen-enter-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
                        <svg id="fullscreen-exit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>
                    </button>
                    <button id="play-pause-btn" class="p-2 rounded-full hover:bg-gray-200" title="Play/Pause">
                        <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                    </button>
                    <button id="next-round-btn" class="p-2 rounded-full hover:bg-green-200 text-green-600" title="Pr√≥ximo Round">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 19 22 12 13 5 13 19"></polygon><polygon points="2 19 11 12 2 5 2 19"></polygon></svg>
                    </button>
                    <button id="end-fight-btn" class="p-2 rounded-full hover:bg-red-200 text-red-500" title="Finalizar Luta">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><line x1="10" y1="10" x2="14" y2="14"></line><line x1="14" y1="10" x2="10" y2="14"></line></svg>
                    </button>
                </div>
            </div>
        </section>

        <!-- Bot√µes de A√ß√£o -->
        <footer class="p-4 grid grid-cols-3 gap-4 items-center">
            <!-- A√ß√µes Esquerda -->
            <div class="flex flex-col gap-4 items-center">
                <button data-action="chute" data-side="esquerdo" class="action-button bg-white p-2 rounded-full shadow-md flex justify-center items-center">
                    <img id="chute-esquerdo-icon" src="resources/chuteEsquerdoVermelho.png" alt="Chute Esquerdo" class="w-16 h-16">
                </button>
                <button data-action="soco" data-side="esquerdo" class="action-button bg-white p-2 rounded-full shadow-md flex justify-center items-center">
                    <img id="soco-esquerdo-icon" src="resources/socoEsquerdoVermelho.png" alt="Soco Esquerdo" class="w-16 h-16">
                </button>
            </div>
            <!-- Altern√¢ncia e A√ß√µes Centrais -->
            <div class="flex flex-col gap-4 items-center">
                <label class="toggle-switch">
                    <input type="checkbox" id="athlete-toggle">
                    <span class="slider"></span>
                </label>
                <button data-action="clinch" class="action-button bg-white p-2 rounded-full shadow-md flex justify-center items-center">
                    <img src="resources/clinch.png" alt="Clinch" class="w-16 h-16">
                </button>
                 <button data-action="falta" class="action-button bg-white p-2 rounded-full shadow-md flex justify-center items-center">
                    <img id="falta-icon" src="resources/faltaVermelho.png" alt="Falta" class="w-16 h-16">
                </button>
            </div>
            <!-- A√ß√µes Direita -->
            <div class="flex flex-col gap-4 items-center">
                <button data-action="chute" data-side="direito" class="action-button bg-white p-2 rounded-full shadow-md flex justify-center items-center">
                     <img id="chute-direito-icon" src="resources/chuteDireitoVermelho.png" alt="Chute Direito" class="w-16 h-16">
                </button>
                <button data-action="soco" data-side="direito" class="action-button bg-white p-2 rounded-full shadow-md flex justify-center items-center">
                    <img id="soco-direito-icon" src="resources/socoDireitoVermelho.png" alt="Soco Direito" class="w-16 h-16">
                </button>
            </div>
        </footer>
    </div>

    <!-- Modal de Detalhes da A√ß√£o -->
    <div id="action-modal" class="fixed bottom-0 left-0 right-0 bg-gray-50 shadow-2xl rounded-t-2xl p-4 z-50 max-w-md mx-auto">
        <h3 id="modal-title" class="text-xl font-bold text-center mb-4">Detalhes da A√ß√£o</h3>
        <div class="space-y-4">
             <div id="time-editor" class="hidden mb-2">
                <label class="font-semibold text-gray-700">Tempo da A√ß√£o (mm:ss)</label>
                <input type="text" id="modal-action-time" class="w-full border border-gray-300 rounded-md p-2 mt-1 text-center font-mono" placeholder="00:00">
            </div>
            <div id="kick-options" class="hidden">
                <div class="mb-2">
                    <label class="font-semibold text-gray-700">Sa√≠da</label>
                    <div id="saida-group" class="flex gap-2 mt-1">
                        <button data-value="frente" class="flex-1 bg-white p-2 rounded-lg shadow-sm">Frente</button>
                        <button data-value="tras" class="flex-1 bg-white p-2 rounded-lg shadow-sm">Tr√°s</button>
                        <button data-value="giro" class="flex-1 bg-white p-2 rounded-lg shadow-sm">Giro</button>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="font-semibold text-gray-700">Contato</label>
                    <div id="contato-group" class="flex gap-2 mt-1">
                        <button data-value="colete" class="flex-1 bg-white p-2 rounded-lg shadow-sm">Colete</button>
                        <button data-value="capacete" class="flex-1 bg-white p-2 rounded-lg shadow-sm">Capacete</button>
                    </div>
                </div>
            </div>
            <div id="generic-options" class="hidden">
                 <div class="mb-2">
                    <label class="font-semibold text-gray-700">Situa√ß√£o</label>
                    <div id="situacao-group" class="flex gap-2 mt-1">
                        <button data-value="ataque" class="flex-1 bg-white p-2 rounded-lg shadow-sm">Ataque</button>
                        <button data-value="defesa" class="flex-1 bg-white p-2 rounded-lg shadow-sm">Contra-Ataque</button>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="font-semibold text-gray-700">√Årea</label>
                    <div id="area-group" class="flex gap-2 mt-1">
                        <button data-value="meio" class="flex-1 bg-white p-2 rounded-lg shadow-sm">Meio</button>
                        <button data-value="canto ofensivo" class="flex-1 bg-white p-2 rounded-lg shadow-sm">Canto Ofens.</button>
                        <button data-value="canto defensivo" class="flex-1 bg-white p-2 rounded-lg shadow-sm">Canto Defen.</button>
                    </div>
                </div>
            </div>
             <div id="foul-options" class="hidden">
                <div class="mb-2">
                    <label class="font-semibold text-gray-700">Tipo de Falta (Gam-jeom)</label>
                    <div id="falta-group" class="grid grid-cols-2 gap-2 mt-1">
                        <button data-value="Sa√≠da da √Årea" class="bg-white p-2 rounded-lg shadow-sm">Sa√≠da da √Årea</button>
                        <button data-value="Evitar Combate" class="bg-white p-2 rounded-lg shadow-sm">Evitar Combate</button>
                        <button data-value="Segurar/Empurrar" class="bg-white p-2 rounded-lg shadow-sm">Segurar/Empurrar</button>
                        <button data-value="Ataque Ilegal" class="bg-white p-2 rounded-lg shadow-sm">Ataque Ilegal</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex gap-4 mt-6">
            <button id="remove-action-btn" class="flex-1 bg-red-500 text-white p-3 rounded-lg font-bold hidden">Remover</button>
            <button id="confirm-action-btn" class="flex-1 bg-green-500 text-white p-3 rounded-lg font-bold">Confirmar</button>
        </div>
    </div>
    
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    
    <!-- Modal de Confirma√ß√£o/Alerta Gen√©rico -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 id="confirm-modal-title" class="text-lg font-bold mb-2 text-gray-800"></h3>
            <p id="confirm-modal-text" class="text-gray-600 mb-6"></p>
            <div id="end-fight-options" class="hidden space-y-4 text-left mb-6">
                 <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" id="pdf-checkbox" class="form-checkbox h-5 w-5 text-blue-600" checked>
                    <span class="text-gray-700">Gerar relat√≥rio PDF</span>
                </label>
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" id="json-checkbox" class="form-checkbox h-5 w-5 text-blue-600">
                    <span class="text-gray-700">Gerar JSON da an√°lise</span>
                </label>
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" id="comment-checkbox" class="form-checkbox h-5 w-5 text-blue-600">
                    <span class="text-gray-700">Adicionar coment√°rio</span>
                </label>
                <div id="comment-container" class="hidden ml-8">
                    <textarea id="scout-comment" rows="3" class="w-full border border-gray-300 rounded-md p-2 mt-2 text-sm" placeholder="Insira seu coment√°rio aqui..."></textarea>
                </div>
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" id="ai-checkbox" class="form-checkbox h-5 w-5 text-blue-600">
                    <span class="text-gray-700">Compartilhar com IA</span>
                </label>
            </div>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300">Cancelar</button>
                <button id="confirm-modal-ok" class="bg-red-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-600">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda -->
    <div id="help-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-6 w-full max-w-md z-50 hidden">
        <div id="help-modal-header" class="flex justify-between items-center pb-3 mb-3 border-b">
            <h3 class="text-lg font-bold text-gray-800">Manual do Usu√°rio</h3>
            <button id="help-modal-close" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
        </div>
        <div class="text-sm text-gray-700 space-y-3 max-h-80 overflow-y-auto">
            <p><strong>Controles da Luta:</strong> Use os bot√µes na parte inferior para iniciar/pausar o cron√¥metro, ir para o pr√≥ximo round, reiniciar ou finalizar a luta.</p>
            <p><strong>Registro de A√ß√µes:</strong> Selecione o atleta ativo usando o seletor (Vermelho/Azul). Toque nos bot√µes de a√ß√£o (chute, soco, etc.) para abrir o menu de detalhes e registrar uma a√ß√£o.</p>
            <p><strong>Editar/Remover A√ß√£o:</strong> Pressione e segure uma a√ß√£o na lista para abrir o menu de edi√ß√£o. L√° voc√™ pode alterar os detalhes, o tempo da a√ß√£o ou remov√™-la.</p>
            <p><strong>Reordenar A√ß√µes:</strong> Arraste e solte uma a√ß√£o na lista para reorden√°-la. O tempo da a√ß√£o ser√° ajustado automaticamente para se encaixar na nova posi√ß√£o.</p>
            <p><strong>Tela Cheia:</strong> Use o bot√£o de tela cheia para uma experi√™ncia imersiva. Em dispositivos iOS, voc√™ precisar√° primeiro "Adicionar √† Tela de In√≠cio" pelo menu de compartilhamento do Safari.</p>
            <p><strong>Finalizar Luta:</strong> Ao finalizar, voc√™ ter√° op√ß√µes para gerar um relat√≥rio em PDF, um arquivo JSON com os dados brutos, adicionar coment√°rios e compartilhar a an√°lise com uma IA para obter estrat√©gias.</p>
            <hr class="my-4">
            <h4 class="font-bold">Autor</h4>
            <p>Este projeto foi idealizado e desenvolvido por <strong>Francisco Breno Moura Alves</strong>.</p>
            <ul class="list-disc list-inside">
                <li><strong>Instagram:</strong> <a href="https://www.instagram.com/fbrenomoura/" target="_blank" class="text-blue-600 hover:underline">@fbrenomoura</a></li>
                <li><strong>LinkedIn:</strong> <a href="https://www.linkedin.com/in/fbrenomoura/" target="_blank" class="text-blue-600 hover:underline">Francisco Breno Moura Alves</a></li>
            </ul>
            <h4 class="font-bold mt-2">üôè Agradecimentos</h4>
            <ul class="list-disc list-inside">
                <li><strong>Samuel Yure (Sayu):</strong> Pelo design dos √≠cones e revis√µes de UI/UX.</li>
            </ul>
        </div>
    </div>


    <canvas id="barChartCanvas" width="400" height="200" class="chart-canvas"></canvas>
    <canvas id="spiderChartCanvas" width="400" height="400" class="chart-canvas"></canvas>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DO DOM ---
            const athleteToggle = document.getElementById('athlete-toggle');
            const timerDisplay = document.getElementById('timer');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const resetBtn = document.getElementById('reset-btn');
            const nextRoundBtn = document.getElementById('next-round-btn');
            const endFightBtn = document.getElementById('end-fight-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const fullscreenEnterIcon = document.getElementById('fullscreen-enter-icon');
            const fullscreenExitIcon = document.getElementById('fullscreen-exit-icon');
            const helpBtn = document.getElementById('help-btn');
            const helpModal = document.getElementById('help-modal');
            const helpModalClose = document.getElementById('help-modal-close');
            const actionButtons = document.querySelectorAll('.action-button');
            const actionModal = document.getElementById('action-modal');
            const modalOverlay = document.getElementById('modal-overlay');
            const confirmBtn = document.getElementById('confirm-action-btn');
            const removeActionBtn = document.getElementById('remove-action-btn');
            const modalTitle = document.getElementById('modal-title');
            const kickOptions = document.getElementById('kick-options');
            const genericOptions = document.getElementById('generic-options');
            const foulOptions = document.getElementById('foul-options');
            const roundDisplay = document.getElementById('round-display');
            const atleta1List = document.getElementById('atleta1-list');
            const atleta2List = document.getElementById('atleta2-list');
            const atleta1ScoreEl = document.getElementById('atleta1-score');
            const atleta2ScoreEl = document.getElementById('atleta2-score');
            const timeEditor = document.getElementById('time-editor');
            const modalActionTime = document.getElementById('modal-action-time');
            
            // √çcones de A√ß√£o
            const chuteEsquerdoIcon = document.getElementById('chute-esquerdo-icon');
            const socoEsquerdoIcon = document.getElementById('soco-esquerdo-icon');
            const chuteDireitoIcon = document.getElementById('chute-direito-icon');
            const socoDireitoIcon = document.getElementById('soco-direito-icon');
            const faltaIcon = document.getElementById('falta-icon');
            
            // Elementos do Modal de Confirma√ß√£o
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalText = document.getElementById('confirm-modal-text');
            const confirmModalCancel = document.getElementById('confirm-modal-cancel');
            const confirmModalOk = document.getElementById('confirm-modal-ok');

            // Elementos do Modal de Finalizar Luta
            const endFightOptions = document.getElementById('end-fight-options');
            const pdfCheckbox = document.getElementById('pdf-checkbox');
            const jsonCheckbox = document.getElementById('json-checkbox');
            const commentCheckbox = document.getElementById('comment-checkbox');
            const aiCheckbox = document.getElementById('ai-checkbox');
            const commentContainer = document.getElementById('comment-container');
            const scoutComment = document.getElementById('scout-comment');


            // --- ESTADO DA APLICA√á√ÉO ---
            let activeAthlete = 'atleta1';
            let fightActions = [];
            let timerInterval = null;
            let seconds = 0;
            let currentRound = 1;
            let currentAction = {};
            let editingActionId = null;
            let pressTimer = null;
            let barChart = null;
            let spiderChart = null;
            let confirmCallback = null;

            // --- FUN√á√ïES DO MODAL DE CONFIRMA√á√ÉO ---
            const showConfirm = (title, text, onConfirm, showCancel = true, isEndFight = false) => {
                confirmModalTitle.textContent = title;
                confirmModalText.textContent = text;
                confirmCallback = onConfirm;
                
                confirmModalCancel.style.display = showCancel ? 'inline-block' : 'none';
                confirmModalOk.textContent = showCancel ? 'Confirmar' : 'OK';

                if (isEndFight) {
                    endFightOptions.classList.remove('hidden');
                    confirmModalText.classList.add('hidden'); // Oculta o texto gen√©rico
                } else {
                    endFightOptions.classList.add('hidden');
                    confirmModalText.classList.remove('hidden');
                }
                
                if (!showCancel) {
                    confirmModalOk.classList.remove('bg-red-500', 'hover:bg-red-600');
                    confirmModalOk.classList.add('bg-blue-500', 'hover:bg-blue-600');
                } else {
                    confirmModalOk.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    confirmModalOk.classList.add('bg-red-500', 'hover:bg-red-600');
                }

                confirmModal.classList.remove('hidden');
                confirmModal.classList.add('flex');
            };

            const hideConfirm = () => {
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
                confirmCallback = null;
                // Reseta as op√ß√µes do modal de finalizar luta para o padr√£o
                pdfCheckbox.checked = true;
                jsonCheckbox.checked = false;
                commentCheckbox.checked = false;
                aiCheckbox.checked = false;
                commentContainer.classList.add('hidden');
                scoutComment.value = '';
            };

            confirmModalOk.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                // N√£o esconde o modal aqui, a fun√ß√£o de callback o far√° se necess√°rio
            });

            confirmModalCancel.addEventListener('click', hideConfirm);


            // --- FUN√á√ïES DO CRON√îMETRO E ROUNDS ---
            const timeToSeconds = (timeStr) => {
                const parts = timeStr.split(':');
                if (parts.length !== 2) return 0;
                const minutes = parseInt(parts[0], 10) || 0;
                const seconds = parseInt(parts[1], 10) || 0;
                return (minutes * 60) + seconds;
            };

            const formatTime = (totalSeconds) => {
                const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                const secondsValue = Math.round(totalSeconds % 60).toString().padStart(2, '0');
                return `${minutes}:${secondsValue}`;
            };

            const updateTimerDisplay = () => {
                timerDisplay.textContent = formatTime(seconds);
            };

            const stopTimer = () => {
                clearInterval(timerInterval);
                timerInterval = null;
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            };

            const startTimer = () => {
                if (timerInterval) return;
                timerInterval = setInterval(() => {
                    seconds++;
                    updateTimerDisplay();
                }, 1000);
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            };

            const toggleTimer = () => {
                if (timerInterval) stopTimer(); else startTimer();
            };
            
            const resetRoundTimer = () => {
                stopTimer();
                seconds = 0;
                updateTimerDisplay();
            };

            const resetFight = () => {
                showConfirm(
                    "Reiniciar Luta?",
                    "Tem certeza que deseja reiniciar a luta? Todos os dados ser√£o perdidos.",
                    () => {
                        resetRoundTimer();
                        currentRound = 1;
                        roundDisplay.textContent = currentRound;
                        fightActions = [];
                        renderActions();
                        hideConfirm();
                    }
                );
            };
            
            const nextRound = () => {
                showConfirm(
                    `Finalizar Round ${currentRound}?`,
                    `Deseja ir para o Round ${currentRound + 1}?`,
                    () => {
                        stopTimer();
                        currentRound++;
                        roundDisplay.textContent = currentRound;
                        resetRoundTimer();
                        renderActions();
                        hideConfirm();
                    }
                );
            };

            // --- FUN√á√ïES DE UI E L√ìGICA ---
            const updateActiveAthleteUI = () => {
                const isAtleta1Active = activeAthlete === 'atleta1';
                document.getElementById('atleta1-container').classList.toggle('border-red-400', isAtleta1Active);
                document.getElementById('atleta1-container').classList.toggle('shadow-lg', isAtleta1Active);
                document.getElementById('atleta2-container').classList.toggle('border-blue-400', !isAtleta1Active);
                document.getElementById('atleta2-container').classList.toggle('shadow-lg', !isAtleta1Active);
                
                // Altera a cor dos √≠cones com base no atleta ativo
                const color = isAtleta1Active ? 'Vermelho' : 'Azul';
                chuteEsquerdoIcon.src = `resources/chuteEsquerdo${color}.png`;
                socoEsquerdoIcon.src = `resources/socoEsquerdo${color}.png`;
                chuteDireitoIcon.src = `resources/chuteDireito${color}.png`;
                socoDireitoIcon.src = `resources/socoDireito${color}.png`;
                faltaIcon.src = `resources/falta${color}.png`;
            };

            const openModal = (action, side, actionToEdit = null) => {
                editingActionId = actionToEdit ? actionToEdit.id : null;
                currentAction = actionToEdit ? JSON.parse(JSON.stringify(actionToEdit)) : { action, side, details: {} };
                
                let title = '';
                kickOptions.classList.add('hidden');
                genericOptions.classList.add('hidden');
                foulOptions.classList.add('hidden');

                if (action === 'chute') {
                    title = `Chute ${side === 'esquerdo' ? 'Esquerdo' : 'Direito'}`;
                    kickOptions.classList.remove('hidden');
                    genericOptions.classList.remove('hidden');
                } else if (action === 'soco') {
                    title = `Soco ${side === 'esquerdo' ? 'Esquerdo' : 'Direito'}`;
                    genericOptions.classList.remove('hidden');
                } else if (action === 'clinch') {
                    title = 'Clinch';
                    genericOptions.classList.remove('hidden');
                } else if (action === 'falta') {
                    title = 'Registrar Falta';
                    foulOptions.classList.remove('hidden');
                }
                modalTitle.textContent = title;
                
                document.querySelectorAll('#action-modal button[data-value]').forEach(btn => btn.classList.remove('bg-blue-500', 'text-white'));

                if(actionToEdit) {
                    removeActionBtn.classList.remove('hidden');
                    timeEditor.classList.remove('hidden');
                    modalActionTime.value = actionToEdit.timestamp;
                    for(const key in actionToEdit.details) {
                        const btn = document.querySelector(`#${key}-group button[data-value="${actionToEdit.details[key]}"]`);
                        if(btn) btn.classList.add('bg-blue-500', 'text-white');
                    }
                } else {
                    removeActionBtn.classList.add('hidden');
                    timeEditor.classList.add('hidden');
                }

                actionModal.classList.add('active');
                modalOverlay.classList.remove('hidden');
            };

            const closeModal = () => {
                actionModal.classList.remove('active');
                modalOverlay.classList.add('hidden');
                editingActionId = null;
            };

            const renderActions = () => {
                atleta1List.innerHTML = '';
                atleta2List.innerHTML = '';
                
                const currentRoundActions = fightActions.filter(a => a.round === currentRound);
                let roundScore1 = 0;
                let roundScore2 = 0;

                currentRoundActions.forEach(action => {
                    const list = action.athlete === 'atleta1' ? atleta1List : atleta2List;
                    const bgColor = action.athlete === 'atleta1' ? 'bg-red-100' : 'bg-blue-100';
                    const textColor = action.athlete === 'atleta1' ? 'text-red-800' : 'text-blue-800';
                    
                    let points = 0;
                    if (action.type === 'chute') {
                        if (action.details.contato === 'colete') points = 2;
                        if (action.details.contato === 'capacete') points = 3;
                        if (action.details.saida === 'giro' && points > 0) points += 2;
                    } else if (action.type === 'soco') { 
                        points = 1;
                    } else if (action.type === 'falta') {
                        if (action.athlete === 'atleta1') roundScore2 += 1; else roundScore1 += 1;
                    }
                    if (action.athlete === 'atleta1') roundScore1 += points; else roundScore2 += points;

                    let actionText = '';
                    if (action.type === 'chute') {
                        actionText = `Chute ${action.details.contato || ''} (${action.details.situacao || ''})`;
                    } else if (action.type === 'soco') {
                        actionText = `Soco (${action.details.situacao || ''})`;
                    } else if (action.type === 'clinch') {
                        actionText = `Clinch (${action.details.situacao || ''})`;
                    } else if (action.type === 'falta') {
                        actionText = `Falta: ${action.details.falta}`;
                    }
                    
                    const item = document.createElement('div');
                    item.dataset.id = action.id;
                    item.className = `${bgColor} ${textColor} p-2 rounded-lg text-sm flex justify-between items-center cursor-move`;
                    item.innerHTML = `<span>${action.timestamp} - ${actionText}</span>`;

                    let pressTimer = null;
                    let hasMoved = false;

                    const handlePressStart = (e) => {
                        hasMoved = false;
                        pressTimer = setTimeout(() => {
                            if (!hasMoved) { // Only trigger if it wasn't a drag
                                const actionToEdit = fightActions.find(a => a.id.toString() === item.dataset.id);
                                if (actionToEdit) {
                                    openModal(actionToEdit.type, actionToEdit.side, actionToEdit);
                                }
                            }
                        }, 500); // 500ms for long press
                    };

                    const handlePressMove = () => {
                        hasMoved = true;
                        clearTimeout(pressTimer);
                    };

                    const handlePressEnd = () => {
                        clearTimeout(pressTimer);
                    };

                    item.addEventListener('mousedown', handlePressStart);
                    item.addEventListener('touchstart', handlePressStart, { passive: true });

                    item.addEventListener('mousemove', handlePressMove);
                    item.addEventListener('touchmove', handlePressMove, { passive: true });

                    item.addEventListener('mouseup', handlePressEnd);
                    item.addEventListener('touchend', handlePressEnd);
                    item.addEventListener('mouseleave', handlePressEnd); // Also cancel on mouse leave

                    list.appendChild(item);
                });

                atleta1ScoreEl.textContent = roundScore1.toString().padStart(2, '0');
                atleta2ScoreEl.textContent = roundScore2.toString().padStart(2, '0');
            };
            
            // --- FUN√á√ïES DE GERA√á√ÉO DE ARQUIVOS ---
            const generateJSON = () => {
                const data = {
                    atleta1: { name: document.getElementById('atleta1-name').value, score: atleta1ScoreEl.textContent },
                    atleta2: { name: document.getElementById('atleta2-name').value, score: atleta2ScoreEl.textContent },
                    totalRounds: currentRound,
                    actions: fightActions
                };
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `luta_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const calculateAllFightStats = () => {
                const getInitialStats = () => ({
                    pontos: 0,
                    faltas: 0,
                    areaPontua: { 'Meio': 0, 'Canto Ofensivo': 0, 'Canto Defensivo': 0 },
                    situacaoPontua: { 'Ataque': 0, 'Contra-Ataque': 0, 'Clinch': 0 },
                    tempoPontua: { '0:00-0:30': 0, '0:30-1:00': 0, '1:00-1:30': 0, '1:30-2:00': 0 }
                });

                let stats1 = getInitialStats();
                let stats2 = getInitialStats();

                fightActions.forEach(act => {
                    let points = 0;
                    let isFoul = false;
                     if (act.type === 'falta') {
                        points = 1;
                        isFoul = true;
                    } else if (act.type === 'chute') {
                        if (act.details.contato === 'colete') points = 2;
                        if (act.details.contato === 'capacete') points = 3;
                        if (act.details.saida === 'giro' && points > 0) points += 2;
                    } else if (act.type === 'soco') { 
                        points = 1;
                    }
                    
                    if (points > 0) {
                        const [min, sec] = act.timestamp.split(':').map(Number);
                        const timeInSeconds = min * 60 + sec;
                        let timeInterval;
                        if (timeInSeconds < 30) timeInterval = '0:00-0:30';
                        else if (timeInSeconds < 60) timeInterval = '0:30-1:00';
                        else if (timeInSeconds < 90) timeInterval = '1:00-1:30';
                        else timeInterval = '1:30-2:00';
                        
                        const scoringAthleteStats = isFoul ? (act.athlete === 'atleta1' ? stats2 : stats1) : (act.athlete === 'atleta1' ? stats1 : stats2);
                        if(isFoul) {
                            if(act.athlete === 'atleta1') stats1.faltas++; else stats2.faltas++;
                        }
                        
                        scoringAthleteStats.pontos += points;
                        
                        if (act.details.area) {
                            scoringAthleteStats.areaPontua[act.details.area.replace('meio','Meio').replace('canto ofensivo','Canto Ofensivo').replace('canto defensivo','Canto Defensivo')] += points;
                        }
                        if (act.type === 'clinch') {
                            scoringAthleteStats.situacaoPontua.Clinch += points;
                        } else if (act.details.situacao) {
                             scoringAthleteStats.situacaoPontua[act.details.situacao.replace('ataque','Ataque').replace('defesa','Contra-Ataque')] += points;
                        }
                        if (timeInterval) {
                           scoringAthleteStats.tempoPontua[timeInterval] += points;
                        }
                    }
                });

                const formatStatsToPercent = (stats) => {
                    const totalPoints = stats.pontos;
                    const newStats = JSON.parse(JSON.stringify(stats));
                    if (totalPoints === 0) return newStats;

                    for (const key in newStats.areaPontua) {
                        newStats.areaPontua[key] = parseFloat((newStats.areaPontua[key] / totalPoints * 100).toFixed(2));
                    }
                    for (const key in newStats.situacaoPontua) {
                        newStats.situacaoPontua[key] = parseFloat((newStats.situacaoPontua[key] / totalPoints * 100).toFixed(2));
                    }
                     for (const key in newStats.tempoPontua) {
                        newStats.tempoPontua[key] = parseFloat((newStats.tempoPontua[key] / totalPoints * 100).toFixed(2));
                    }
                    return newStats;
                };

                return {
                    stats1: formatStatsToPercent(stats1),
                    stats2: formatStatsToPercent(stats2)
                };
            };
            
            const drawBarChart = (doc, canvas, data, labels, startY) => {
                const ctx = canvas.getContext('2d');
                if (barChart) barChart.destroy();
                barChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Pontua√ß√£o (%)',
                            data: data,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        scales: { 
                            x: { 
                                beginAtZero: true, 
                                max: 100,
                                ticks: { font: { size: 14 } } 
                            },
                            y: {
                                ticks: { font: { size: 14 } } 
                            }
                        },
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                titleFont: { size: 14 }, 
                                bodyFont: { size: 12 } 
                            }
                        },
                        animation: { duration: 0 }
                    }
                });
                const chartImage = canvas.toDataURL('image/png');
                doc.addImage(chartImage, 'PNG', 15, startY, 180, 80);
                return doc.lastAutoTable.finalY + 95;
            };

            const generatePDF = (comment = '') => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const athlete1Name = document.getElementById('atleta1-name').value;
                const athlete2Name = document.getElementById('atleta2-name').value;
                const { stats1, stats2 } = calculateAllFightStats();
                const barCanvas = document.getElementById('barChartCanvas');
                const spiderCanvas = document.getElementById('spiderChartCanvas');
                
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                let finalY = 0;

                const checkPageBreak = (neededHeight) => {
                    if (finalY + neededHeight > pageHeight - margin) {
                        doc.addPage();
                        finalY = margin;
                    }
                };

                // --- CABE√áALHO ---
                doc.setFontSize(18);
                doc.text(`Relat√≥rio de Luta: ${athlete1Name} vs ${athlete2Name}`, 14, 22);
                doc.setFontSize(11);
                doc.setTextColor(100);
                doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')} | Rounds: ${currentRound}`, 14, 30);
                doc.setFontSize(14);
                doc.text(`Placar Final: ${stats1.pontos} x ${stats2.pontos}`, 14, 38);
                finalY = 45;

                // --- COMENT√ÅRIO DO SCOUT (SE EXISTIR) ---
                if (comment.trim() !== '') {
                    checkPageBreak(30);
                    doc.setFontSize(16);
                    doc.text('Coment√°rio do Scout', 14, finalY);
                    finalY += 7;
                    doc.setFontSize(11);
                    doc.setTextColor(80);
                    const commentLines = doc.splitTextToSize(comment, 180);
                    doc.text(commentLines, 14, finalY);
                    finalY += (commentLines.length * 5) + 5;
                }

                // --- S√öMULA DA LUTA ---
                checkPageBreak(20);
                doc.setFontSize(16);
                doc.setTextColor(0);
                doc.text('S√∫mula da Luta', 14, finalY);
                const sumulaBody = fightActions.map(act => {
                    let actionDesc = '';
                    if (act.type === 'chute') actionDesc = `Chute ${act.details.contato || ''}`;
                    else if (act.type === 'soco') actionDesc = 'Soco';
                    else if (act.type === 'clinch') actionDesc = 'Clinch';
                    else if (act.type === 'falta') actionDesc = `Falta (${act.details.falta})`;
                    
                    const details = act.details.situacao ? act.details.situacao.replace('defesa', 'Contra-Ataque') : '';
                    const athleteName = act.athlete === 'atleta1' ? athlete1Name : athlete2Name;
                    return [act.round, act.timestamp, athleteName, actionDesc, details];
                });
                doc.autoTable({
                    head: [['Round', 'Tempo', 'Atleta', 'A√ß√£o', 'Detalhes']],
                    body: sumulaBody,
                    startY: finalY + 5,
                    theme: 'striped'
                });
                finalY = doc.lastAutoTable.finalY;

                // --- PAR√ÇMETROS DA LUTA ---
                finalY += 15;
                checkPageBreak(20);
                doc.setFontSize(16);
                doc.text('Par√¢metros da Luta', 14, finalY);
                finalY += 10;

                const athletes = [
                    { name: athlete1Name, stats: stats1, opponentStats: stats2 },
                    { name: athlete2Name, stats: stats2, opponentStats: stats1 }
                ];

                athletes.forEach(athlete => {
                    // √Årea
                    checkPageBreak(130);
                    doc.setFontSize(12);
                    doc.text(`An√°lise de √Årea - ${athlete.name}`, 14, finalY);
                    doc.autoTable({
                        head: [['√Årea da Quadra que Pontua (%)', '√Årea da Quadra que Sofre Pontos (%)']],
                        body: Object.keys(athlete.stats.areaPontua).map(key => [`${key}: ${athlete.stats.areaPontua[key]}%`, `${key}: ${athlete.opponentStats.areaPontua[key]}%`]),
                        startY: finalY + 5, theme: 'grid', headStyles: { fillColor: [41, 128, 185] }
                    });
                    finalY = drawBarChart(doc, barCanvas, Object.values(athlete.stats.areaPontua), Object.keys(athlete.stats.areaPontua), doc.lastAutoTable.finalY + 5);

                    // Situa√ß√£o
                    checkPageBreak(130);
                    doc.setFontSize(12);
                    doc.text(`An√°lise de Situa√ß√£o - ${athlete.name}`, 14, finalY);
                    doc.autoTable({
                        head: [['Situa√ß√£o que Pontua (%)', 'Situa√ß√£o que o Advers√°rio Pontua (%)']],
                        body: Object.keys(athlete.stats.situacaoPontua).map(key => [`${key}: ${athlete.stats.situacaoPontua[key]}%`, `${key}: ${athlete.opponentStats.situacaoPontua[key]}%`]),
                        startY: finalY + 5, theme: 'grid', headStyles: { fillColor: [22, 160, 133] }
                    });
                    finalY = drawBarChart(doc, barCanvas, Object.values(athlete.stats.situacaoPontua), Object.keys(athlete.stats.situacaoPontua), doc.lastAutoTable.finalY + 5);
                    
                    // Tempo
                    checkPageBreak(130);
                    doc.setFontSize(12);
                    doc.text(`An√°lise de Tempo - ${athlete.name}`, 14, finalY);
                    doc.autoTable({
                        head: [['Tempo que Pontua (%)', 'Tempo que o Advers√°rio Pontua (%)']],
                        body: Object.keys(athlete.stats.tempoPontua).map(key => [`${key}: ${athlete.stats.tempoPontua[key]}%`, `${key}: ${athlete.opponentStats.tempoPontua[key]}%`]),
                        startY: finalY + 5, theme: 'grid', headStyles: { fillColor: [243, 156, 18] }
                    });
                    finalY = drawBarChart(doc, barCanvas, Object.values(athlete.stats.tempoPontua), Object.keys(athlete.stats.tempoPontua), doc.lastAutoTable.finalY + 5);
                });

                // Spider Graph Page
                checkPageBreak(200);
                doc.setFontSize(16);
                doc.text('Vis√£o Geral de Performance', 14, finalY);
                const spiderCtx = spiderCanvas.getContext('2d');
                if (spiderChart) spiderChart.destroy();

                const spiderLabels = [
                    'Chute Cabe√ßa', 'Chute Colete', 'Chute c/ Giro',
                    'Soco', 'Ataques', 'Contra-Ataques', 'Faltas'
                ];

                const athlete1Data = [
                    fightActions.filter(a => a.athlete === 'atleta1' && a.type === 'chute' && a.details.contato === 'capacete').length,
                    fightActions.filter(a => a.athlete === 'atleta1' && a.type === 'chute' && a.details.contato === 'colete').length,
                    fightActions.filter(a => a.athlete === 'atleta1' && a.type === 'chute' && a.details.saida === 'giro').length,
                    fightActions.filter(a => a.athlete === 'atleta1' && a.type === 'soco').length,
                    fightActions.filter(a => a.athlete === 'atleta1' && a.details.situacao === 'ataque').length,
                    fightActions.filter(a => a.athlete === 'atleta1' && a.details.situacao === 'defesa').length,
                    stats1.faltas
                ];

                const athlete2Data = [
                    fightActions.filter(a => a.athlete === 'atleta2' && a.type === 'chute' && a.details.contato === 'capacete').length,
                    fightActions.filter(a => a.athlete === 'atleta2' && a.type === 'chute' && a.details.contato === 'colete').length,
                    fightActions.filter(a => a.athlete === 'atleta2' && a.type === 'chute' && a.details.saida === 'giro').length,
                    fightActions.filter(a => a.athlete === 'atleta2' && a.type === 'soco').length,
                    fightActions.filter(a => a.athlete === 'atleta2' && a.details.situacao === 'ataque').length,
                    fightActions.filter(a => a.athlete === 'atleta2' && a.details.situacao === 'defesa').length,
                    stats2.faltas
                ];

                spiderChart = new Chart(spiderCtx, {
                    type: 'radar',
                    data: {
                        labels: spiderLabels,
                        datasets: [{
                            label: athlete1Name,
                            data: athlete1Data,
                            backgroundColor: 'rgba(239, 83, 80, 0.2)',
                            borderColor: 'rgba(239, 83, 80, 1)',
                            borderWidth: 2
                        }, {
                            label: athlete2Name,
                            data: athlete2Data,
                            backgroundColor: 'rgba(66, 165, 245, 0.2)',
                            borderColor: 'rgba(66, 165, 245, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: { 
                        animation: { duration: 0 }, 
                        scales: { 
                            r: { 
                                beginAtZero: true, 
                                ticks: { stepSize: 1, font: { size: 12 } },
                                pointLabels: { font: { size: 14 } }
                            } 
                        },
                        plugins: {
                            legend: { labels: { font: { size: 14 } } }
                        }
                    }
                });
                const spiderImage = spiderCanvas.toDataURL('image/png');
                doc.addImage(spiderImage, 'PNG', 15, finalY + 10, 180, 180);

                doc.save(`relatorio_luta_${Date.now()}.pdf`);
            };
            
            // --- Fun√ß√µes para compartilhar com IA ---
            const generateReportTextForAI = (comment = '') => {
                const athlete1Name = document.getElementById('atleta1-name').value;
                const athlete2Name = document.getElementById('atleta2-name').value;
                const { stats1, stats2 } = calculateAllFightStats();
                
                let reportText = "Fa√ßa uma an√°lise dessa avalia√ß√£o de scout de uma luta de taekwondo, e me retorne com uma estrat√©gia para ganhar dos atletas.\n\n";
                
                reportText += `--- RELAT√ìRIO DE LUTA ---\n`;
                reportText += `Luta: ${athlete1Name} vs ${athlete2Name}\n`;
                reportText += `Data: ${new Date().toLocaleDateString('pt-BR')} | Rounds: ${currentRound}\n`;
                reportText += `Placar Final: ${stats1.pontos} (Vermelho) x ${stats2.pontos} (Azul)\n\n`;

                if (comment.trim() !== '') {
                    reportText += `--- COMENT√ÅRIO DO SCOUT ---\n${comment}\n\n`;
                }

                reportText += `--- S√öMULA DA LUTA ---\n`;
                reportText += `Round | Tempo | Atleta | A√ß√£o | Detalhes\n`;
                fightActions.forEach(act => {
                    let actionDesc = '';
                    if (act.type === 'chute') actionDesc = `Chute ${act.details.contato || ''}`;
                    else if (act.type === 'soco') actionDesc = 'Soco';
                    else if (act.type === 'clinch') actionDesc = 'Clinch';
                    else if (act.type === 'falta') actionDesc = `Falta (${act.details.falta})`;
                    const details = act.details.situacao ? act.details.situacao.replace('defesa', 'Contra-Ataque') : '';
                    const athleteName = act.athlete === 'atleta1' ? athlete1Name : athlete2Name;
                    reportText += `${act.round} | ${act.timestamp} | ${athleteName} | ${actionDesc} | ${details}\n`;
                });
                reportText += "\n";

                const athletes = [
                    { name: athlete1Name, stats: stats1, opponentStats: stats2 },
                    { name: athlete2Name, stats: stats2, opponentStats: stats1 }
                ];

                athletes.forEach(athlete => {
                    reportText += `--- AN√ÅLISE DE PERFORMANCE: ${athlete.name} ---\n`;
                    reportText += `Pontos Totais: ${athlete.stats.pontos} | Faltas Cometidas: ${athlete.stats.faltas}\n\n`;
                    reportText += `√Årea que Pontua (%): Meio ${athlete.stats.areaPontua['Meio']}%, Canto Ofens. ${athlete.stats.areaPontua['Canto Ofensivo']}%, Canto Defens. ${athlete.stats.areaPontua['Canto Defensivo']}%\n`;
                    reportText += `Situa√ß√£o que Pontua (%): Ataque ${athlete.stats.situacaoPontua['Ataque']}%, Contra-Ataque ${athlete.stats.situacaoPontua['Contra-Ataque']}%, Clinch ${athlete.stats.situacaoPontua['Clinch']}%\n\n`;
                });
                
                return reportText;
            };

            const shareOrCopyForAI = async (text) => {
                // Verifica se a Web Share API √© suportada (comum em dispositivos m√≥veis)
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'An√°lise de Luta TKD Scout',
                            text: text,
                        });
                        // Ap√≥s o compartilhamento (ou cancelamento), esconde o modal.
                        hideConfirm();
                    } catch (err) {
                        console.error('Share failed or was cancelled', err);
                        // Mesmo se falhar (ex: usu√°rio cancelou), esconde o modal.
                        hideConfirm();
                    }
                } else {
                    // Fallback para desktop: copiar para a √°rea de transfer√™ncia
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed'; // Previne rolagem da p√°gina
                    textarea.style.opacity = 0;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showConfirm("Copiado!", "O texto para an√°lise da IA foi copiado para a √°rea de transfer√™ncia.", () => { hideConfirm(); }, false);
                    } catch (err) {
                        showConfirm("Erro", "N√£o foi poss√≠vel copiar o texto.", () => { hideConfirm(); }, false);
                    }
                    document.body.removeChild(textarea);
                }
            };

            const toggleFullScreen = () => {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);

                if (isIOS && !isInStandaloneMode) {
                    showConfirm(
                        "Tela Cheia no iOS",
                        "Para usar o modo de tela cheia, adicione este aplicativo √† sua Tela de In√≠cio: toque no √≠cone de Compartilhar e depois em 'Adicionar √† Tela de In√≠cio'.",
                        () => { hideConfirm(); },
                        false // Apenas bot√£o OK
                    );
                    return;
                }

                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                    });
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            };

            const updateFullscreenIcons = () => {
                if (document.fullscreenElement) {
                    fullscreenEnterIcon.classList.add('hidden');
                    fullscreenExitIcon.classList.remove('hidden');
                } else {
                    fullscreenEnterIcon.classList.remove('hidden');
                    fullscreenExitIcon.classList.add('hidden');
                }
            };

            const makeDraggable = (element, handle) => {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                handle.onmousedown = dragMouseDown;

                function dragMouseDown(e) {
                    e = e || window.event;
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    document.onmousemove = elementDrag;
                }

                function elementDrag(e) {
                    e = e || window.event;
                    e.preventDefault();
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    element.style.top = (element.offsetTop - pos2) + "px";
                    element.style.left = (element.offsetLeft - pos1) + "px";
                }

                function closeDragElement() {
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            };

            // --- EVENT LISTENERS ---
            athleteToggle.addEventListener('change', (e) => {
                activeAthlete = e.target.checked ? 'atleta2' : 'atleta1';
                updateActiveAthleteUI();
            });

            playPauseBtn.addEventListener('click', toggleTimer);
            resetBtn.addEventListener('click', resetFight);
            nextRoundBtn.addEventListener('click', nextRound);
            fullscreenBtn.addEventListener('click', toggleFullScreen);
            document.addEventListener('fullscreenchange', updateFullscreenIcons);
            helpBtn.addEventListener('click', () => {
                helpModal.classList.remove('hidden');
                modalOverlay.classList.remove('hidden');
            });
            helpModalClose.addEventListener('click', () => {
                 helpModal.classList.add('hidden');
                 modalOverlay.classList.add('hidden');
            });


            endFightBtn.addEventListener('click', () => {
                if (fightActions.length === 0) {
                    showConfirm("Nenhuma A√ß√£o", "Nenhuma a√ß√£o foi registrada. Adicione a√ß√µes antes de finalizar a luta.", () => { hideConfirm(); }, false);
                    return;
                }
                showConfirm(
                    "Finalizar Luta",
                    "", // Texto gen√©rico √© ocultado
                    () => { // Callback do bot√£o OK
                        stopTimer();
                        const comment = commentCheckbox.checked ? scoutComment.value : '';

                        if (pdfCheckbox.checked) {
                            setTimeout(() => generatePDF(comment), 100);
                        }
                        if (jsonCheckbox.checked) {
                            generateJSON();
                        }
                        if (aiCheckbox.checked) {
                            const aiText = generateReportTextForAI(comment);
                            shareOrCopyForAI(aiText);
                        } else {
                           hideConfirm();
                        }
                    },
                    true, // Mostra o bot√£o cancelar
                    true // Indica que √© o modal de finalizar luta
                );
            });

            commentCheckbox.addEventListener('change', () => {
                commentContainer.classList.toggle('hidden', !commentCheckbox.checked);
            });

            actionButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    const side = btn.dataset.side;
                    openModal(action, side);
                });
            });

            modalOverlay.addEventListener('click', () => {
                closeModal();
                helpModal.classList.add('hidden');
                modalOverlay.classList.add('hidden');
            });


            removeActionBtn.addEventListener('click', () => {
                if (!editingActionId) return;
                fightActions = fightActions.filter(act => act.id !== editingActionId);
                renderActions();
                closeModal();
            });

            confirmBtn.addEventListener('click', () => {
                if (editingActionId) {
                    const actionIndex = fightActions.findIndex(a => a.id === editingActionId);
                    if (actionIndex > -1) {
                        fightActions[actionIndex].details = currentAction.details;
                        fightActions[actionIndex].timestamp = modalActionTime.value;
                        // Re-sort array by timestamp
                        fightActions.sort((a, b) => timeToSeconds(a.timestamp) - timeToSeconds(b.timestamp));
                    }
                } else {
                    const newAction = {
                        id: Date.now(),
                        athlete: activeAthlete,
                        type: currentAction.action,
                        side: currentAction.side,
                        timestamp: formatTime(seconds),
                        round: currentRound,
                        details: currentAction.details
                    };
                    fightActions.push(newAction);
                }
                renderActions();
                closeModal();
            });

            document.querySelectorAll('#action-modal button[data-value]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const group = btn.parentElement;
                    const property = group.id.replace('-group', '');
                    const value = btn.dataset.value;
                    
                    if (btn.classList.contains('bg-blue-500')) {
                        btn.classList.remove('bg-blue-500', 'text-white');
                        delete currentAction.details[property];
                    } else {
                        group.querySelectorAll('button').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
                        btn.classList.add('bg-blue-500', 'text-white');
                        currentAction.details[property] = value;
                    }
                });
            });

            // --- INICIALIZA√á√ÉO ---
            updateActiveAthleteUI();
            updateTimerDisplay();
            makeDraggable(helpModal, document.getElementById('help-modal-header'));

            const sortableOptions = {
                group: 'shared',
                animation: 150,
                onEnd: (evt) => {
                    // 1. Obter a lista de IDs na nova ordem do DOM para o round atual
                    const currentRoundActionsMap = new Map(fightActions.filter(a => a.round === currentRound).map(a => [a.id.toString(), a]));
                    const otherRoundsActions = fightActions.filter(a => a.round !== currentRound);
                    
                    const allItemsInRound = [...atleta1List.children, ...atleta2List.children];
                    const newOrderedRoundActions = allItemsInRound.map(item => currentRoundActionsMap.get(item.dataset.id));

                    // 2. Atualizar o atleta se a a√ß√£o mudou de lista
                    const movedActionId = parseInt(evt.item.dataset.id);
                    const movedAction = newOrderedRoundActions.find(a => a.id === movedActionId);
                    if (evt.to !== evt.from) {
                        movedAction.athlete = evt.to.id.includes('atleta1') ? 'atleta1' : 'atleta2';
                    }

                    // 3. Recalcular o timestamp da a√ß√£o movida
                    const movedActionIndex = newOrderedRoundActions.findIndex(a => a.id === movedActionId);
                    const prevAction = newOrderedRoundActions[movedActionIndex - 1];
                    const nextAction = newOrderedRoundActions[movedActionIndex + 1];

                    let newTimeInSeconds;
                    if (prevAction && nextAction) {
                        const prevTime = timeToSeconds(prevAction.timestamp);
                        const nextTime = timeToSeconds(nextAction.timestamp);
                        newTimeInSeconds = (prevTime + nextTime) / 2;
                    } else if (prevAction) {
                        newTimeInSeconds = timeToSeconds(prevAction.timestamp) + 1;
                    } else if (nextAction) {
                        const nextTime = timeToSeconds(nextAction.timestamp);
                        newTimeInSeconds = nextTime > 1 ? nextTime - 1 : nextTime / 2;
                    } else {
                        newTimeInSeconds = timeToSeconds(movedAction.timestamp); // Mant√©m o original se for a √∫nica a√ß√£o
                    }
                    movedAction.timestamp = formatTime(newTimeInSeconds);

                    // 4. Reordenar a lista do round atual pelo novo tempo
                    newOrderedRoundActions.sort((a, b) => timeToSeconds(a.timestamp) - timeToSeconds(b.timestamp));

                    // 5. Juntar com as a√ß√µes dos outros rounds e atualizar o array principal
                    fightActions = [...otherRoundsActions, ...newOrderedRoundActions];
                    fightActions.sort((a,b) => a.round - b.round || timeToSeconds(a.timestamp) - timeToSeconds(b.timestamp));

                    // 6. Renderizar a UI
                    renderActions();
                }
            };
            new Sortable(atleta1List, sortableOptions);
            new Sortable(atleta2List, sortableOptions);
        });
    </script>
</body>
</html>
